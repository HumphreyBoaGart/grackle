#!/bin/bash
# gruser - User Management component for Grackle
# More info at https://github.com/HumphreyBoaGart/grackle

### All script functions are thrown in a simple case statement
case $1 in

### Script documentation with 'gruser help'
help | -h | --help)
exec cat <<EOF
  ▄▄ • ▄▄▄   ▄▄▄·  ▄▄· ▄ •▄ ▄▄▌  ▄▄▄ .
 ▐█ ▀ ▪▀▄ █·▐█ ▀█ ▐█ ▌▪█▌▄▌▪██•  ▀▄.▀·
 ▄█ ▀█▄▐▀▀▄ ▄█▀▀█ ██ ▄▄▐▀▀▄·██▪  ▐▀▀▪▄
 ▐█▄▪▐█▐█•█▌▐█ ▪▐▌▐███▌▐█.█▌▐█▌▐▌▐█▄▄▌
 ·▀▀▀▀ .▀  ▀ ▀  ▀ ·▀▀▀ ·▀  ▀.▀▀▀  ▀▀▀ 
 $(tput setaf 4 bold)USER ACCOUNT MANAGEMENT:$(tput sgr0)
  Omit USERNAME et al, to trigger interactive mode.

  $(tput setaf 3 bold)Create new local user:$(tput sgr0)
    $(tput setaf 6)gruser new USERNAME$(tput sgr0)

  $(tput setaf 3 bold)Delete local user:$(tput sgr0)
    $(tput bold)Only Account:$(tput sgr0) $(tput setaf 6)gruser delete USERNAME$(tput sgr0)
    $(tput bold)Account & All Data:$(tput sgr0) $(tput setaf 6)gruser purge USERNAME$(tput sgr0)

  $(tput setaf 3 bold)Reset user's homedir permissions:$(tput sgr0)
    $(tput setaf 6)gruser fix-perms USERNAME$(tput sgr0)

  $(tput setaf 3 bold)Grant user shell access:$(tput sgr0)
    $(tput setaf 6)gruser shell-on USERNAME$(tput sgr0)

  $(tput setaf 3 bold)Revoke user's shell access:$(tput sgr0)
    $(tput setaf 6)gruser shell-off USERNAME$(tput sgr0)

  $(tput setaf 3 bold)Upgrade user to administrator:$(tput sgr0)
    $(tput setaf 6)gruser admin-on USERNAME$(tput sgr0)

  $(tput setaf 3 bold)Downgrade user from administrator:$(tput sgr0)
    $(tput setaf 6)gruser admin-off USERNAME$(tput sgr0)

  $(tput setaf 3 bold)Full documentation index:$(tput sgr0)
    $(tput setaf 6)grackle help$(tput sgr0)

EOF
;;

### Generate new local user account with 'gruser new'
new)
  # Fill in name to skip interactive mode
  if [[ $2 != '' ]]; then

    # Filter input
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}

  # Otherwise, go to interactive mode
  else
    echo " $(tput setaf 6 bold)Please enter a username for your new user:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name

    # Filter input
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi

  # Create new user with sanitized inputs
  if [[ $name != '' ]]; then
    useradd $name -Um --skel /opt/grackle/skel/home/user --shell /sbin/nologin
    usermod -aG user $name
    sed -i -e 's/{{USERNAME}}/'$name'/g' /home/$name/.bash_aliases
    sed -i -e 's/{{USERNAME}}/'$name'/g' /home/$name/.bash_logout
    sed -i -e 's/{{USERNAME}}/'$name'/g' /home/$name/.bashrc
    sed -i -e 's/{{USERNAME}}/'$name'/g' /home/$name/.profile
    mkdir -pv /home/$name/.local/mail/cur /home/$name/.local/mail/new /home/$name/.local/mail/tmp

    # Create ~/.gracklevar with initial metadata
    tee "/home/$name/.gracklevar" >/dev/null <<EOF
{
	"type": "user",
	"user": "$name"
}
EOF

    # Tidy up permissions
    gruser fix-perms $name
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Upgrade user to administrator with 'gruser admin-on'
admin-on)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter a username to grant admin access to:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    usermod -aG adm $name
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Downgrade user from administrator with 'gruser admin-off'
admin-off)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter a username to revoke admin access from:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    usermod -rG adm $name
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Homebrew package manager with 'grapp brew-setup'
brew-setup)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter a username to grant Homebrew access to:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    # Set up Environment
    gruser shell-on $name
    cd /home/$name
    rm -rf /home/$name/.linuxbrew
    sudo -u $name mkdir -p /home/$name/.linuxbrew/bin/
    # Grab Homebrew package
    sudo -u $name git clone https://github.com/Homebrew/brew /home/$name/.linuxbrew/Homebrew
    sudo -u $name ln -sf /home/$name/.linuxbrew/Homebrew/bin/brew /home/$name/.linuxbrew/bin/brew
    sudo -u $name /home/$name/.linuxbrew/Homebrew/bin/brew update --force
    sudo -u $name /home/$name/.linuxbrew/Homebrew/bin/brew doctor
    # Make accessible & set permissions
    sudo -u $name ln -sf /home/$name/.linuxbrew/Homebrew/bin/brew /home/$name/.local/bin/brew
    chown -R $name:$name /home/$name/.linuxbrew /home/$name/.local
    chmod -R g-rwx,o-rwx /home/$name/.linuxbrew /home/$name/.local
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Grant user shell access with 'gruser shell-on'
shell-on)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter a username to grant shell access to:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    usermod -s /bin/bash $name
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Grant user shell access with 'gruser shell-off'
shell-off)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter a username to revoke shell access from:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    usermod -s /sbin/nologin $name
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Delete local user account and keep homedir with 'gruser delete'
delete)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Which account shall we delete?$(tput sgr0)"
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    usermod -rG $name nginx
    userdel -f $name
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Nuke local user account and all data with 'gruser purge'
purge)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Which account shall we purge?$(tput sgr0)"
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    usermod -rG $name nginx
    userdel -rf $name
    rm -rf /home/$name
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Permissions-Fixing Utilities with 'gruser fix-perms'
fix-perms)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter an account username:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    # Make sure account is in the right group
    usermod -aG user $name
    usermod -rG app $name
    # Set homedir permissions
    chown -Rv $name:$name /home/$name
    chmod -Rv u+rwX,g-rwx,o-rwx /home/$name
    chown "root:$name" "/home/$name/.gracklevar"
    chmod 640 "/home/$name/.gracklevar"
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Output error for any input not explicitly defined
*)
exec cat <<EOF

  $(tput setaf 1 bold)GRACKLE ERROR: No valid command specified!$(tput sgr0)

   Run $(tput setaf 6 bold)gruser help$(tput sgr0) for a full list of User Management commands.
   Run $(tput setaf 6 bold)grackle help$(tput sgr0) for a full list of Grackle components.

EOF
;;

### Close initial case statement and move on with our life
esac
