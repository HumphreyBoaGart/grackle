#!/bin/bash
# grackle - Simple web server management for the people!
# More info at https://github.com/HumphreyBoaGart/grackle

### All script functions are thrown in a simple case statement
case $1 in

### Script documentation with 'grinstall help'
help | -h | --help)
exec cat <<EOF
  ▄▄ • ▄▄▄   ▄▄▄·  ▄▄· ▄ •▄ ▄▄▌  ▄▄▄ .
 ▐█ ▀ ▪▀▄ █·▐█ ▀█ ▐█ ▌▪█▌▄▌▪██•  ▀▄.▀·
 ▄█ ▀█▄▐▀▀▄ ▄█▀▀█ ██ ▄▄▐▀▀▄·██▪  ▐▀▀▪▄
 ▐█▄▪▐█▐█•█▌▐█ ▪▐▌▐███▌▐█.█▌▐█▌▐▌▐█▄▄▌
 ·▀▀▀▀ .▀  ▀ ▀  ▀ ·▀▀▀ ·▀  ▀.▀▀▀  ▀▀▀ 
 $(tput setaf 4 bold)INSTALLER UTILITY:$(tput sgr0)

  $(tput setaf 3 bold)To install Grackle base components w/ Nginx:$(tput sgr0)
    $(tput setaf 6)grinstall web$(tput sgr0)

  $(tput setaf 3 bold)To install Grackle and all optional components:$(tput sgr0)
    $(tput setaf 6)grinstall full$(tput sgr0)

  $(tput setaf 3 bold)To install Grackle components a la carte:$(tput sgr0)
    $(tput bold)Base:$(tput sgr0) $(tput setaf 6)grinstall base$(tput sgr0)
    $(tput bold)Docker:$(tput sgr0) $(tput setaf 6)grinstall docker$(tput sgr0)
    $(tput bold)Nginx:$(tput sgr0) $(tput setaf 6)grinstall nginx$(tput sgr0)
    $(tput bold)PHP:$(tput sgr0) $(tput setaf 6)grinstall php$(tput sgr0)

  $(tput setaf 3 bold)Full documentation index:$(tput sgr0)
    $(tput setaf 6)grackle help$(tput sgr0)

EOF
;;

### Base install with 'grinstall base'
base)
  # Set up secure base environment
  apt install -y ufw fail2ban
  ufw reset
  ufw default deny incoming
  ufw default deny outgoing
  ufw allow 22/tcp
  ufw allow out 22/tcp
  ufw allow out 53/tcp
  ufw allow out 53/udp
  ufw allow out 80/tcp
  ufw allow out 123/udp
  ufw allow out 443/tcp
  ufw enable
  cp -v /opt/grackle/skel/etc/fail2ban/jail.local /etc/fail2ban/jail.local
  touch /var/log/auth.log
  systemctl enable fail2ban
  systemctl start fail2ban
  systemctl restart fail2ban

  # Create usergroups and import new root .dotfiles
  cp -bv /opt/grackle/skel/root/.bash_logout /root/.bash_logout
  cp -bv /opt/grackle/skel/root/.bashrc /root/.bashrc
  cp -bv /opt/grackle/skel/root/.profile /root/.profile
  mkdir -pv /root/.config/ranger
  cp -bv /opt/grackle/skel/root/.config/ranger/rc.conf /root/.config/ranger/rc.conf
  groupadd adm
  groupadd user
  groupadd app
  groupadd cliapp

  # Clean up permissions
  chown -vR root:root /opt/grackle
  chmod -vR u+rwX,g-rwx,o-rwx /opt/grackle
  chmod -v u=rwx,g=rx,o=rx /opt/grackle /opt/grackle/bin /opt/grackle/bin/shortcuts
  chmod -v u=rwx,g=rx /opt/grackle/bin/grackle /opt/grackle/bin/grapp /opt/grackle/bin/grbuild /opt/grackle/bin/gruser
  chgrp -v adm /opt/grackle/bin/grackle /opt/grackle/bin/grapp /opt/grackle/bin/grbuild /opt/grackle/bin/gruser
  chmod -vR g+rX,o+rX /opt/grackle/errors /opt/grackle/void /opt/grackle/bin/README.md

  # Configure apt
  cp -bv /opt/grackle/skel/etc/apt/sources.list /etc/apt/sources.list
  cp -bv /opt/grackle/skel/etc/apt/sources.list.d/debian.list /etc/apt/sources.list.d/debian.list
  chmod -vR u+rwX,g+rX,o+rX /etc/apt/
  apt update
  apt install -y apt-transport-https ca-certificates debian-archive-keyring gnupg2 lsb-release

  # Install additional packages
  apt install -y build-essential bzip2 file gzip imagemagick jq mawk procps rsync sudo tar unrar-free unzip zip
  apt install -y -t bookworm-backports 7zip curl byobu
  apt purge -y ntp
  apt install -y aptitude btop chrony git htop logrotate ranger rsyslog sqlite3 wget
  systemctl enable chrony
  systemctl enable ufw

  # Configure syslog
  cp -v /opt/grackle/skel/etc/syslog/boycottjournald.conf /etc/systemd/journald.conf.d/boycottjournald.conf
  rm -v /etc/rsyslog.conf /etc/rsyslog.d/20-ufw.conf
  cp -v /opt/grackle/skel/etc/syslog/rsyslog.conf /etc/rsyslog.conf
  cp -v /opt/grackle/skel/etc/syslog/rsyslog.d/20-ufw.conf /etc/rsyslog.d/20-ufw.conf
  cp -v /opt/grackle/skel/etc/syslog/rsyslog.d/20-fail2ban.conf /etc/rsyslog.d/20-fail2ban.conf
  cp -v /opt/grackle/skel/etc/fail2ban/10-syslog.conf /etc/fail2ban/fail2ban.d/10-syslog.conf
  cp -v /opt/grackle/skel/etc/syslog/rsyslog.d/94-journald.conf /etc/rsyslog.d/94-journald.conf
  rm -v /var/log/syslog
  systemctl enable rsyslog
  systemctl restart fail2ban rsyslog
  systemctl restart systemd-journald
  rm -rfv /var/log/journal /var/log/syslog
  cp -v /opt/grackle/skel/etc/syslog/local-logs.conf /etc/tmpfiles.d/local-logs.conf
  systemd-tmpfiles --create /etc/tmpfiles.d/local-logs.conf

  # Additional configuration
  rm -v /etc/adduser.conf
  cp -bv /opt/grackle/skel/etc/ssh/sshd_config /etc/ssh/sshd_config
  cp -v /opt/grackle/skel/etc/adduser.conf /etc/adduser.conf
  useradd -D -s /sbin/nologin
  rm -v /etc/motd /etc/issue /etc/issue.net
  touch /etc/issue /etc/issue/net
  cp -bv /opt/grackle/skel/etc/motd /etc/motd

  # Grab latest dart-sass
  set -euo pipefail
  url="$(
    curl -fsSL https://api.github.com/repos/sass/dart-sass/releases/latest \
    | jq -r '.assets[]
           | select(.name | endswith("linux-x64.tar.gz"))
           | .browser_download_url' \
    | head -n1
  )"
  rm -rfv /opt/dart-sass
  curl -fL "$url" | sudo tar -xz -C /opt
  chmod -Rv u+rwX,g+rX,o+rX /opt/dart-sass
  ln -sf /opt/dart-sass/sass /usr/local/bin/sass

  # Close installer
;;


### Homebrew package manager with 'grinstall brew'
brew)
  # Set up install environment
  gruser new brew
  gruser shell-on brew
  chmod 750 /home/brew
  cd /home/brew
  rm -rf ./.linuxbrew

  # Grab Homebrew package
  sudo -u brew git clone https://github.com/Homebrew/brew /home/brew/.linuxbrew/Homebrew
  sudo -u brew ln -sf /home/brew/.linuxbrew/Homebrew/bin/brew /home/brew/.local/bin/brew
  sudo -u brew /home/brew/.linuxbrew/Homebrew/bin/brew update --force
  sudo -u brew /home/brew/.linuxbrew/Homebrew/bin/brew doctor

  # Set Permissions
  chown -R brew:brew /home/brew/.linuxbrew
  chmod -R g-w,o-rwx /home/brew
  chmod -R g+rX /home/brew/.linuxbrew

  # Close installer
;;

### ChatGPT Codex stack with 'grinstall codex'
codex)
  # Make sure Homebrew is installed
  grinstall brew

 ## TO DO: Grab and configure Codex from Homebrew, and secure.  
  
  # Close installer
;;

### Rootless Docker install with 'grinstall docker'
docker)
  # Close installer
;;

### FTP server install with 'grinstall ftp'
ftp)
  # Install vsftp
  apt install -y vsftpd
  systemctl enable vsftpd
  rm /etc/vsftpd.conf
  cp -v /opt/grackle/skel/etc/vsftpd.conf /etc/vsftpd.conf
  service vsftpd restart

  # Update firewall rules
  ufw allow out 20/tcp
  ufw allow 21/tcp
  ufw allow out 21/tcp
  ufw allow out 989/tcp
  ufw allow 990/tcp
  ufw allow out 990/tcp
  ufw allow 40000:50000/tcp
  ufw allow out 40000:50000/tcp
  ufw reload

  # Close installer
;;

### IRC client & monitoring utils with 'grinstall irc'
irc)
  # Install base packages
  apt install -y -t bookworm-backports weechat

  # Update firewall rules and reload ufw
  ufw allow out 6667/tcp
  ufw allow out 6697/tcp
  ufw allow out 7000/tcp
  ufw allow out 7070/tcp
  ufw allow out 9999/tcp
  ufw reload

  # Close installer
;;

### Local mail server with 'grinstall mail'
mail)
  # Pull hostname from server for sed to use
  HOSTNAME=$(hostname)

  # Install base packages
  apt install -y postfix dovecot-lmtpd postfix-policyd-spf-python mutt

  # Set up daemon accounts/groups
  adduser dovecot mail

  # Create postmaster account to catch utility emails
  gruser new postmaster
  gruser shell-on postmaster

  # Configure Postfix & Dovecot
  cp -v /opt/grackle/skel/etc/postfix/master.cf /etc/postfix/master.cf
  cp -v /opt/grackle/skel/etc/postfix/main.cf /etc/postfix/main.cf
  cp -v /opt/grackle/skel/etc/postfix/header_checks /etc/postfix/header_checks
  chmod -v a+r /etc/postfix/header_checks
  sed -i -e 's/{HOSTNAME}/'$HOSTNAME'/g' /etc/postfix/main.cf
  cp -v /opt/grackle/skel/etc/dovecot/dovecot.conf /etc/dovecot/dovecot.conf
  cp -v /opt/grackle/skel/etc/dovecot/conf.d/10-mail.conf /etc/dovecot/conf.d/10-mail.conf
  cp -v /opt/grackle/skel/etc/dovecot/conf.d/10-master.conf /etc/dovecot/conf.d/10-master.conf
  cp -v /opt/grackle/skel/etc/dovecot/conf.d/10-auth.conf /etc/dovecot/conf.d/10-auth.conf
  cp -v /opt/grackle/skel/etc/dovecot/conf.d/10-ssl.conf /etc/dovecot/conf.d/10-ssl.conf
  sed -i -e 's/{HOSTNAME}/'$HOSTNAME'/g' /etc/dovecot/conf.d/10-ssl.conf
  systemctl enable postfix dovecot
  systemctl restart postfix dovecot

  # Install and configure OpenDKIM
  apt install -y opendkim opendkim-tools
  gpasswd -a postfix opendkim
  cp -v /opt/grackle/skel/etc/opendkim/opendkim.conf /etc/opendkim.conf
  mkdir -vp /etc/opendkim/keys
  chown -Rv opendkim:opendkim /etc/opendkim
  cp -v /opt/grackle/skel/etc/opendkim/signing.table /etc/opendkim/signing.table
  cp -v /opt/grackle/skel/etc/opendkim/key.table /etc/opendkim/key.table
  cp -v /opt/grackle/skel/etc/opendkim/trusted.hosts /etc/opendkim/trusted.hosts
  sed -i -e 's/{HOSTNAME}/'$HOSTNAME'/g' /etc/opendkim/signing.table
  sed -i -e 's/{HOSTNAME}/'$HOSTNAME'/g' /etc/opendkim/key.table
  sed -i -e 's/{HOSTNAME}/'$HOSTNAME'/g' /etc/opendkim/trusted.hosts
  mkdir -v /etc/opendkim/keys/$HOSTNAME
  opendkim-genkey -b 2048 -d $HOSTNAME -D /etc/opendkim/keys/$HOSTNAME -s default -v
  chown -Rv opendkim:opendkim /etc/opendkim/keys
  chmod -v g+rx,o-rwx /etc/opendkim/keys
  chmod 600 /etc/opendkim/keys/$HOSTNAME/default.private
  chmod 640 /etc/opendkim/keys/$HOSTNAME/default.txt
  mkdir -v /var/spool/postfix/opendkim
  chown -v opendkim:postfix /var/spool/postfix/opendkim
  chmod -v g+rx /var/spool/postfix/opendkim
  cp -v /opt/grackle/skel/etc/default/opendkim /etc/default/opendkim
  systemctl enable opendkim
  systemctl restart opendkim postfix

  # Install and configure OpenDMARC
  apt install -y opendmarc
  adduser postfix opendmarc
  cp -v /opt/grackle/skel/etc/opendmarc.conf /etc/opendmarc.conf
  sed -i -e 's/{HOSTNAME}/'$HOSTNAME'/g' /etc/opendmarc.conf
  mkdir -pv /var/spool/postfix/opendmarc
  chown -v opendmarc:opendmarc /var/spool/postfix/opendmarc -R
  chmod -v 750 /var/spool/postfix/opendmarc/ -R
  systemctl enable opendmarc
  systemctl restart opendmarc postfix

  # Reload services and reset twice to make sure everything dials in
  systemctl reload postfix dovecot opendkim opendmarc
  systemctl restart postfix dovecot opendkim opendmarc
  systemctl restart postfix dovecot opendkim opendmarc

  # Set up default aliases
  cp -v /opt/grackle/skel/etc/aliases /etc/aliases
  newaliases

  # Update firewall rules and reload ufw
  ufw allow 25/tcp
  ufw allow out 25/tcp
  ufw allow out 465/tcp
  ufw allow out 587/tcp
  ufw reload

  # Close installer
;;

### Nginx server with 'grinstall nginx'
nginx)
  # Configure official Nginx repo
  curl https://nginx.org/keys/nginx_signing.key | gpg --dearmor \
    | tee /usr/share/keyrings/nginx-archive-keyring.gpg >/dev/null
  chmod a+r /usr/share/keyrings/nginx-archive-keyring.gpg
  echo "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] \
    http://nginx.org/packages/debian `lsb_release -cs` nginx" \
    | tee /etc/apt/sources.list.d/nginx.list
  chmod a+r /etc/apt/sources.list.d/nginx.list
  echo -e "Package: *\nPin: origin nginx.org\nPin: release o=nginx\nPin-Priority: 900\n" \
    | tee /etc/apt/preferences.d/99nginx
  chmod a+r /etc/apt/preferences.d/99nginx

  # Install Nginx
  apt update
  apt install -y nginx
  systemctl start nginx
  systemctl enable nginx

  # Configure Nginx
  mkdir -pv /etc/nginx/active /etc/nginx/available /etc/nginx/gates /etc/nginx/includes
  touch /etc/nginx/gates/void
  rm -rf /etc/nginx/conf.d/ /etc/nginx/nginx.conf
  cp -v /opt/grackle/skel/etc/nginx/nginx.conf /etc/nginx/nginx.conf
  cp -v /opt/grackle/skel/etc/nginx/includes/headers.conf /etc/nginx/includes/headers.conf
  cp -v /opt/grackle/skel/etc/nginx/includes/ssl.conf /etc/nginx/includes/ssl.conf
  cp -v /opt/grackle/skel/etc/nginx/includes/util.conf /etc/nginx/includes/util.conf
  chgrp -Rv nginx /etc/nginx
  chmod -Rv g+rX /etc/nginx
  mkdir -pv /var/log/nginx
  chown -Rv nginx:adm /var/log/nginx
  chmod -Rv u+rwX,g+rX,o-rwX /var/log/nginx

  # Install Certbot
  apt install -y certbot python3-certbot-nginx

  # Update firewall rules and reload Nginx
  ufw allow 80/tcp
  ufw allow 443/tcp
  ufw reload
  grackle reset-web

  # Close installer
;;

### PHP daemon with 'grinstall php'
php)
  # Configure Sury repo for newer PHP releases
  curl -sSLo /tmp/debsuryorg-archive-keyring.deb https://packages.sury.org/debsuryorg-archive-keyring.deb
  dpkg -i /tmp/debsuryorg-archive-keyring.deb
  echo "deb [signed-by=/usr/share/keyrings/deb.sury.org-php.gpg] \
     https://packages.sury.org/php/ $(lsb_release -sc) main" \
     > /etc/apt/sources.list.d/php.list
  chmod a+r /etc/apt/sources.list.d/php.list
  apt update

  # Install PHP 8.5 & PHP-FPM from Sury
  apt install -y php8.5 php8.5-fpm php8.5-{bz2,cli,curl,gd,imagick,intl,mbstring,readline,sqlite3,xml,zip} composer
  systemctl enable php8.5-fpm

  # Configure PHP-FPM
  mkdir -pv /etc/php/8.5/fpm/pool.available
  rm /etc/php/8.5/fpm/pool.d/www.conf
  cp -v /opt/grackle/skel/etc/php/php-fpm.conf /etc/php/8.5/fpm/php-fpm.conf
  cp -v /opt/grackle/skel/etc/syslog/rsyslog.d/30-phpfpm.conf /etc/rsyslog.d/30-phpfpm.conf
  systemctl restart rsyslog
  grackle reset-php

  # Close installer
;;


###
###
###>>>>> TODO
###>>>>> MOVE UPDATE/REINSTALL FUNCTIONS TO DEDICATED `grupdate`
###
###
### Update Grackle with 'grinstall update'
update)
  # Delete old /opt/ contents and resync to repo
  rm -rfv /opt/grackle
  # Edit URL here to enable updating Grackle from custom fork
  git clone https://github.com/HumphreyBoaGart/grackle /opt/grackle

  # Clean up permissions
  chmod -v u=rwx /opt/grackle/bin/grinstall
  chown -vR root:root /opt/grackle
  chmod -vR u+rwX,g-rwx,o-rwx /opt/grackle
  chmod -v u=rwx,g=rx,o=rx /opt/grackle /opt/grackle/bin /opt/grackle/bin/shortcuts
  chmod -v u=rwx,g=rx /opt/grackle/bin/grackle /opt/grackle/bin/grapp /opt/grackle/bin/grbuild /opt/grackle/bin/gruser
  chmod -v u=rwx /opt/grackle/bin/grinstall
  chgrp -v adm /opt/grackle/bin/grackle /opt/grackle/bin/grapp /opt/grackle/bin/grbuild /opt/grackle/bin/gruser
  chmod -vR g+rX,o+rX /opt/grackle/errors /opt/grackle/void /opt/grackle/bin/README.md

  # Grab latest dart-sass
  set -euo pipefail
  url="$(
    curl -fsSL https://api.github.com/repos/sass/dart-sass/releases/latest \
    | jq -r '.assets[]
           | select(.name | endswith("linux-x64.tar.gz"))
           | .browser_download_url' \
    | head -n1
  )"
  rm -rfv /opt/dart-sass
  curl -fL "$url" | sudo tar -xz -C /opt
  chmod -Rv u+rwX,g+rX,o+rX /opt/dart-sass
  ln -sf /opt/dart-sass/sass /usr/local/bin/sass

  # Close updater
;;

### Update Grackle and reinsert some config files with 'grinstall reinstall'
reinstall)
  # Delete old /opt/ contents and resync to repo
  rm -rfv /opt/grackle
  # Edit URL here to enable reinstalling Grackle from custom fork
  git clone https://github.com/HumphreyBoaGart/grackle /opt/grackle

  # Clean up permissions
  chmod -v u=rwx /opt/grackle/bin/grinstall
  chown -vR root:root /opt/grackle
  chmod -vR u+rwX,g-rwx,o-rwx /opt/grackle
  chmod -v u=rwx,g=rx,o=rx /opt/grackle /opt/grackle/bin /opt/grackle/bin/shortcuts
  chmod -v u=rwx,g=rx /opt/grackle/bin/grackle /opt/grackle/bin/grapp /opt/grackle/bin/grbuild /opt/grackle/bin/gruser
  chmod -v u=rwx /opt/grackle/bin/grinstall
  chgrp -v adm /opt/grackle/bin/grackle /opt/grackle/bin/grapp /opt/grackle/bin/grbuild /opt/grackle/bin/gruser
  chmod -vR g+rX,o+rX /opt/grackle/errors /opt/grackle/void /opt/grackle/bin/README.md
  groupadd adm
  groupadd user
  groupadd app
  groupadd cliapp

  # Recopy various /etc files from base installer
  cp -bv /opt/grackle/skel/etc/fail2ban/jail.local /etc/fail2ban/jail.local
  cp -bv /opt/grackle/skel/root/.bash_logout /root/.bash_logout
  cp -bv /opt/grackle/skel/root/.bashrc /root/.bashrc
  cp -bv /opt/grackle/skel/root/.profile /root/.profile
  cp -bv /opt/grackle/skel/root/.config/ranger/rc.conf /root/.config/ranger/rc.conf
  cp -bv /opt/grackle/skel/etc/syslog/boycottjournald.conf /etc/systemd/journald.conf.d/boycottjournald.conf
  cp -bv /opt/grackle/skel/etc/syslog/rsyslog.conf /etc/rsyslog.conf
  cp -bv /opt/grackle/skel/etc/syslog/rsyslog.d/20-ufw.conf /etc/rsyslog.d/20-ufw.conf
  cp -bv /opt/grackle/skel/etc/syslog/rsyslog.d/20-fail2ban.conf /etc/rsyslog.d/20-fail2ban.conf
  cp -bv /opt/grackle/skel/etc/fail2ban/10-syslog.conf /etc/fail2ban/fail2ban.d/10-syslog.conf
  cp -bv /opt/grackle/skel/etc/syslog/rsyslog.d/94-journald.conf /etc/rsyslog.d/94-journald.conf
  cp -bv /opt/grackle/skel/etc/syslog/local-logs.conf /etc/tmpfiles.d/local-logs.conf
  systemd-tmpfiles --create /etc/tmpfiles.d/local-logs.conf
  cp -bv /opt/grackle/skel/etc/adduser.conf /etc/adduser.conf
  cp -bv /opt/grackle/skel/etc/motd /etc/motd

  # Re-enable and restart base services
  systemctl restart fail2ban
  systemctl restart rsyslog
  
  # Grab latest dart-sass
  set -euo pipefail
  url="$(
    curl -fsSL https://api.github.com/repos/sass/dart-sass/releases/latest \
    | jq -r '.assets[]
           | select(.name | endswith("linux-x64.tar.gz"))
           | .browser_download_url' \
    | head -n1
  )"
  rm -rfv /opt/dart-sass
  curl -fL "$url" | sudo tar -xz -C /opt
  chmod -Rv u+rwX,g+rX,o+rX /opt/dart-sass
  ln -sf /opt/dart-sass/sass /usr/local/bin/sass

  # Close updater
;;

### Output error for any input not explicitly defined
*)
exec cat <<EOF

  $(tput setaf 1 bold)GRACKLE INSTALLER ERROR: No valid install mode specified!$(tput sgr0)

   Run $(tput setaf 6 bold)grinstall help$(tput sgr0) for a full list of Installer options.

EOF
;;

### Close initial case statement and move on with our life
esac
