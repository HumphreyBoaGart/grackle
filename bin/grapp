#!/bin/bash
# grapp - Application management component for Grackle
# More info at https://github.com/HumphreyBoaGart/grackle

### All script functions are thrown in a simple case statement
case $1 in

### Script documentation with 'grapp help'
help | -h | --help)
exec cat <<EOF
  ▄▄ • ▄▄▄   ▄▄▄·  ▄▄· ▄ •▄ ▄▄▌  ▄▄▄ .
 ▐█ ▀ ▪▀▄ █·▐█ ▀█ ▐█ ▌▪█▌▄▌▪██•  ▀▄.▀·
 ▄█ ▀█▄▐▀▀▄ ▄█▀▀█ ██ ▄▄▐▀▀▄·██▪  ▐▀▀▪▄
 ▐█▄▪▐█▐█•█▌▐█ ▪▐▌▐███▌▐█.█▌▐█▌▐▌▐█▄▄▌
 ·▀▀▀▀ .▀  ▀ ▀  ▀ ·▀▀▀ ·▀  ▀.▀▀▀  ▀▀▀ 
 $(tput setaf 4 bold)APP ACCOUNT MANAGEMENT:$(tput sgr0)
  Omit USERNAME et al, to trigger interactive mode.

  $(tput setaf 3 bold)Create new app account:$(tput sgr0)
    $(tput setaf 6)grapp new USERNAME$(tput sgr0)

  $(tput setaf 3 bold)Delete app account:$(tput sgr0)
    $(tput bold)Only Account:$(tput sgr0) $(tput setaf 6)grapp delete USERNAME$(tput sgr0)
    $(tput bold)Account & All Data:$(tput sgr0) $(tput setaf 6)grapp purge USERNAME$(tput sgr0)

  $(tput setaf 3 bold)Fix app's homedir permissions:$(tput sgr0)
    $(tput bold)General Fix:$(tput sgr0) $(tput setaf 6)grapp fix-perms USERNAME$(tput sgr0)
    $(tput bold)Deep Fix (Careful!):$(tput sgr0) $(tput setaf 6)grapp fix-perms-deep USERNAME$(tput sgr0)

  $(tput setaf 3 bold)Full documentation index:$(tput sgr0)
    $(tput setaf 6)grackle help$(tput sgr0)

EOF
;;

### Generate new application account with 'grapp new'
new)

  # Fill in name & domain to skip interactive mode
  if [[ $2 != '' ]] && [[ $3 != '' ]]; then

    # Filter input
    name=${2// /_} # Remove spaces
    name=${name//[^a-zA-Z0-9_]/} # Remove anything not alphanumeric or _
    domain=${3// /_} # Remove spaces
    domain=${domain//[^a-zA-Z0-9._-]/} # Remove anything not alphanumeric, -, _ or .
    domain=${domain#[-.]}  # Remove leading - or .
    domain=${domain%[-.]}  # Remove trailing - or l
  fi

  # Otherwise, go to interactive mode
  if [[ $2 = '' ]] && [[ $3 = '' ]]; then

    # Ask for user input and filter
    echo " $(tput setaf 6 bold)Please enter a username for your new application:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_} # Remove spaces
    name=${name//[^a-zA-Z0-9_]/} # Remove anything not alphanumeric or _
    echo " $(tput setaf 6 bold)Please enter the address of your new application:$(tput sgr0)"
    echo -n "  (ie: domain.com or subdomain.domain.com) "
    read -r domain
    domain=${domain// /_} # Remove spaces
    domain=${domain//[^a-zA-Z0-9._-]/} # Remove anything not alphanumeric, -, _ or .
    domain=${domain#[-.]}  # Remove leading - or .
    domain=${domain%[-.]}  # Remove trailing - or l
  fi

  # Create new app with sanitized inputs, but only if we have both
  if [[ $name != '' ]] && [[ $domain != '' ]]; then
    useradd $name -Um --skel /opt/grackle/skel/home/app --shell /sbin/nologin
    usermod -aG app $name
    usermod -aG $name nginx
    usermod -c $domain $name
    sed -i -e 's/{{USERNAME}}/'$name'/g' /home/$name/.bash_aliases
    sed -i -e 's/{{USERNAME}}/'$name'/g' /home/$name/.bash_logout
    sed -i -e 's/{{USERNAME}}/'$name'/g' /home/$name/.bashrc
    sed -i -e 's/{{USERNAME}}/'$name'/g' /home/$name/.profile
    cp -v /opt/grackle/skel/etc/nginx/available/basic_http /etc/nginx/available/$name.conf
    ln -s /etc/nginx/available/$name.conf /etc/nginx/active/$name.conf
    sed -i -e 's/{{USERNAME}}/'$name'/g' /etc/nginx/available/$name.conf
    sed -i -e 's/{{DOMAIN}}/'$domain'/g' /etc/nginx/available/$name.conf

    # Create ~/.gracklevar with initial metadata
    tee "/home/$name/.gracklevar" >/dev/null <<EOF
{
	"type": "app",
	"user": "$name",
	"url": "$domain",
	"docker": "no",
	"php": 0
}
EOF

    # Tidy up permissions
    grapp fix-perms-deep $name
    chown -Rv root:nginx /etc/nginx
    chmod -Rv u+rwX,g+rX,o-rwx /etc/nginx
    grackle reset-web

    # Make sure app username can't somehow get mail
    echo "$name: /dev/null" >> /etc/aliases
    newaliases

  # Fail and quit if inputs are still empty
  else
    exec echo " $(tput setaf 1 bold)ERROR: You cannot skip interactive mode unless you enter a name AND address!$(tput sgr0)"
  fi
;;

### Local Homebrew package manager with 'grapp brew-setup'
brew-setup)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter a username to grant Homebrew access to:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    # Set up Environment
    gruser shell-on $name
    cd /home/$name
    rm -rf /home/$name/.linuxbrew
    sudo -u $name mkdir -p /home/$name/.linuxbrew/bin/
    # Grab Homebrew package
    sudo -u $name git clone https://github.com/Homebrew/brew /home/$name/.linuxbrew/Homebrew
    sudo -u $name ln -sf /home/$name/.linuxbrew/Homebrew/bin/brew /home/$name/.linuxbrew/bin/brew
    sudo -u $name /home/$name/.linuxbrew/Homebrew/bin/brew update --force
    sudo -u $name /home/$name/.linuxbrew/Homebrew/bin/brew doctor
    # Make accessible & set permissions
    sudo -u $name ln -sf /home/$name/.linuxbrew/Homebrew/bin/brew /home/$name/.local/bin/brew
    chown -R $name:$name /home/$name/.linuxbrew /home/$name/.local
    chmod -R g-rwx,o-rwx /home/$name/.linuxbrew /home/$name/.local
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Grant app Server Homebrew access with 'grapp brew-on'
brew-on)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter a username to grant Homebrew access to:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    usermod -aG linuxbrew $name
 ###TO-DO> Add '/home/linuxbrew/.local/bin' to $name's PATH
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Revoke Server Homebrew access from app with 'grapp brew-off'
brew-off)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter a username to revoke Homebrew access from:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    usermod -rG linuxbrew $name
 ###TO-DO> Remove '/home/linuxbrew/.local/bin' to $name's PATH
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Enable PHP access for app with 'grapp php-on'
php-on)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter an app name to enable PHP access for:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    ln -s /etc/php/8.5/fpm/pool.available/$name.conf /etc/php/8.5/fpm/pool.d/$name.conf
    grackle reset-web
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter an account name!$(tput sgr0)"
  fi
;;

### Disable PHP access for app with 'grapp php-off'
php-off)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter an app name to revoke PHP access from:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    rm /etc/php/8.5/fpm/pool.d/$name.conf
    grackle reset-php
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter an account name!$(tput sgr0)"
  fi
;;

### Set up PHP access for app with 'grapp php-setup'
php-setup)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter an app name to grant PHP access to:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    # Check for existing PHP config & failsafe
   ### TO DO

    # Read domain from ~/.gracklevar
    domain="$(jq -er '.url | select(type=="string" and length>0)' "/home/$name/.gracklevar")" || {
      echo "ERROR: .gracklevar missing or .url empty for $name" >&2; exit 2;
    }
    esc_domain="$(printf '%s' "$domain" | sed 's/[&/\]/\\&/g')"

    # Copy skeleton files and insert appdata
    cp -v /opt/grackle/skel/etc/php/pool.d/pool.conf /etc/php/8.5/fpm/pool.available/$name.conf
    ln -s /etc/php/8.5/fpm/pool.available/$name.conf /etc/php/8.5/fpm/pool.d/$name.conf
    sed -i -e 's/{{USERNAME}}/'$name'/g' /etc/php/8.5/fpm/pool.available/$name.conf
    sed -i -e "s/{{DOMAIN}}/$esc_domain/g" "/etc/php/8.5/fpm/pool.available/$name.conf"
    t="$(mktemp)"; jq --argjson v 8.5 '.php=$v' "/home/$name/.gracklevar" >"$t" && mv "$t" "/home/$name/.gracklevar"
    cp -v /opt/grackle/skel/etc/php/composer.json /home/$name/app/composer.json
    sed -i -e 's/{{USERNAME}}/'$name'/g' /home/$name/app/composer.json
    mkdir -pv /home/$name/.local/share/php/opcache/file
    mkdir -pv /home/$name/.local/share/php/opcache/lock
    mkdir -pv /home/$name/.local/share/php/sessions
    mkdir -pv /home/$name/.local/share/php/soap
    mkdir -pv /home/$name/.local/share/php/tmp_upload
    mkdir -pv /home/$name/logs/php-fpm
    cp -v /opt/grackle/skel/etc/php/logdir-readme.md /home/$name/logs/php-fpm/README.md
    grapp fix-perms $name
    grackle reset-php
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter an account name!$(tput sgr0)"
  fi
;;


### Grant app shell access with 'grapp shell-on'
shell-on)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter a username to grant shell access to:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    usermod -s /bin/bash $name
    usermod -aG cliapp $name
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Grant app shell access with 'grapp shell-off'
shell-off)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter a username to revoke shell access from:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    usermod -s /sbin/nologin $name
    usermod -rG cliapp $name
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Enable web access to app with 'grapp web-on'
web-on)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter an app name to restore web access to:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    ln -s /etc/nginx/available/$name.conf /etc/nginx/active/$name.conf
    grackle reset-web
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter an account name!$(tput sgr0)"
  fi
;;

### Revoke web access to app with 'grapp web-off'
web-off)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter an app name to revoke web access from:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    rm /etc/nginx/active/$name.conf
    grackle reset-web
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter an account name!$(tput sgr0)"
  fi
;;

### Backup application account, preserving data with 'grapp backup'
backup)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Which application shall we backup?$(tput sgr0)"
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    tar -czf "/home/$name/backups/backup-$name-$(date +%Y%m%d%H%M%S%N | cut -c1-16).tar.gz" "/home/$name/.gracklevar" "/home/$name/app" "/home/$name/logs"
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter an application name!$(tput sgr0)"
  fi
;;

### Delete application account, preserving data with 'grapp delete'
delete)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Which application shall we delete?$(tput sgr0)"
    echo -n "  (WARNING: OBNOXIOUS TO UNDO!) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    usermod -rG $name nginx
    userdel -f $name
    rm -rf /etc/nginx/active/$name.conf
    grackle reset-web
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter an application name!$(tput sgr0)"
  fi
;;

### Nuke application account and all data with 'grapp purge'
purge)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Which application shall we purge?$(tput sgr0)"
    echo -n "  (WARNING: CANNOT BE UNDONE!) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    usermod -rG $name nginx
    userdel -rf $name
    rm -rf /home/$name /etc/nginx/active/$name.conf /etc/nginx/available/$name.conf
    grackle reset-web
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter an application name!$(tput sgr0)"
  fi
;;

### Permissions-Fixing Utilities with 'grapp fix-perms'
fix-perms)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter an account username:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    # Make sure account is in the right group
    usermod -aG app $name
    usermod -rG user $name
    # Set initial homedir permissions
    chown -R $name:$name /home/$name
    chmod u+rwX,g+rX,o+rX /home/$name
    # Additional resets
    chmod -R u+rwX,g+rX /home/$name/app
    chmod -R g-w,o-rwx /home/$name/app
    chmod -R u+rwX,g-rwx,o-rwx /home/$name/app/private
    chmod -R u+rwX,g-rwx,o-rwx /home/$name/.config
    chmod -R u+rwX,g-rwx,o-rwx /home/$name/.local
    chmod -R g+rX /home/$name/.local/share/php
    chmod -R u+rwX,g-rwx,o-rwx /home/$name/backups
    chmod -R u+rwX,g-rwx,o-rwx /home/$name/logs
    chmod -R g+rwX /home/$name/logs/nginx
    chmod u+rwX,g-rwx,o-rwx /home/$name/.bash_aliases /home/$name/.bash_logout /home/$name/.bashrc /home/$name/.profile
    chown root:$name /home/$name/.gracklevar
    chmod 640 /home/$name/.gracklevar
    # Tweak top-level homedir permissions for SSH chrooting to work
    chmod u+rwX,g+rX,o+rX /home/$name
    chmod g-w,o-w /home/$name
    chown root:root /home/$name
 else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;
fix-perms-deep)
  if [[ $2 != '' ]]; then
    name=${2// /_}
    name=${name//[^a-zA-Z0-9_]/}
  else
    echo " $(tput setaf 6 bold)Please enter an account username:$(tput sgr0)"
    echo -n "  (alphanumeric only) "
    read -r name
    name=${name// /_}
    name=${name//[^a-zA-Z0-9_]/}
  fi
  if [[ $name != '' ]]; then
    # Make sure account is in the right group
    usermod -aG app $name
    usermod -rG user $name
    # Set initial homedir permissions
    chown -R $name:$name /home/$name
    chmod u+rwX,g+rX,o+rX /home/$name
    # Additional resets
    chmod -R u+rwX,g+rX /home/$name/app
    chmod -R g-w,o-rwx /home/$name/app
    chmod -R u+rwX,g-rwx,o-rwx /home/$name/app/private
    chmod -R u+rwX,g-rwx,o-rwx /home/$name/.config
    chmod -R u+rwX,g-rwx,o-rwx /home/$name/.local
    chmod -R g+rX /home/$name/.local/share/php
    chmod -R u+rwX,g-rwx,o-rwx /home/$name/backups
    chmod -R u+rwX,g-rwx,o-rwx /home/$name/logs
    chmod -R g+rwX /home/$name/logs/nginx
    chmod u+rwX,g-rwx,o-rwx /home/$name/.bash_aliases /home/$name/.bash_logout /home/$name/.bashrc /home/$name/.profile
    chown root:$name /home/$name/.gracklevar
    chmod 640 /home/$name/.gracklevar
    # Tweak top-level homedir permissions for SSH chrooting to work
    chmod u+rwX,g+rX,o+rX /home/$name
    chmod g-w,o-w /home/$name
    chown root:root /home/$name
  else
    exec echo " $(tput setaf 1 bold)ERROR: You did not enter a username!$(tput sgr0)"
  fi
;;

### Output error for any input not explicitly defined
*)
exec cat <<EOF

  $(tput setaf 1 bold)GRACKLE ERROR: No valid command specified!$(tput sgr0)

   Run $(tput setaf 6 bold)grapp help$(tput sgr0) for a full list of App Management commands.
   Run $(tput setaf 6 bold)grackle help$(tput sgr0) for a full list of Grackle components.

EOF
;;

### Close initial case statement and move on with our life
esac
